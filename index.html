<!DOCTYPE html>
<html>
  <head>
    <title>Pneumonia Detector</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-image: url('https://png.pngtree.com/thumb_back/fw800/background/20240310/pngtree-pneumonia-patient-image_15639809.jpg');
        background-repeat: no-repeat;
        background-size: cover;
        background-position: center;
        background-color: rgb(29, 31, 32);
        color: #ffffff;
      }

      .section {
        margin-top: 50px;
      }

      .chatbot {
        background-color: transparent;
        color: #ffffff;
        font-weight: bold;
        border-left: 5px solid #2a9d8f;
        padding: 30px;
        font-size: 30px; /* Increased font size */
        box-shadow: none;
        border-radius: 8px;
        max-width: 700px;
        margin: 40px auto;
      }

      .chatbot span.char {
        opacity: 0;
        display: inline-block;
        transition: opacity 0.3s ease;
      }

      .chatbot span.char.visible {
        opacity: 1;
      }

      #animated-title span {
        opacity: 0;
        display: inline-block;
        transition: opacity 0.3s ease;
      }

      #animated-title span.visible {
        opacity: 1;
      }

      #animated-title {
        font-size: 36px; /* Larger title text */
        font-weight: bold;
      }
    </style>
  </head>

  <body>
    <hr style="margin-top: 0px; opacity: 1" color="#2a9d8f" size="10" width="100%" />
    <h1 id="animated-title" style="margin-top: 100px; text-align: center;"></h1>

    <form class="p-3 text-center" action="/" method="post" enctype="multipart/form-data">
      <h2 style="margin: 30px; text-align: center">Please Upload an X-Ray Image</h2>
      <input
        class="border border-black border-2"
        style="background-color: white; border-radius: 10px"
        type="file"
        name="imagefile"
        required
        autofocus
      />
      <br />
      <input class="btn btn-primary mt-3" style="background-color: #2a9d8f; border: none" type="submit" value="Predict" />
    </form>

    {% if prediction %}
    <div class="section">
      <h2 class="text-center" style="margin: 30px">Person is Pneumonia {{prediction}}</h2>
      <div class="d-flex justify-content-center">
        <img src="{{imagePath}}" alt="Image Not Found" height="224" width="224" />
      </div>

      {% if 'Positive' in prediction %}
      <div id="chatbot-response" class="chatbot mt-4">
        <div style="margin-bottom: 10px;">
          <strong>ðŸ©º Chatbot:</strong> The person is Pneumonia Positive. Here are some health suggestions:
        </div>
        <ul id="suggestion-list">
          <li>Consult a pulmonologist immediately.</li>
          <li>Take a full chest X-ray and additional tests.</li>
          <li>Start a prescribed course of antibiotics or antivirals.</li>
          <li>Rest well and stay hydrated.</li>
          <li>Avoid smoking and exposure to pollutants.</li>
        </ul>
      </div>
      {% endif %}
    </div>
    {% endif %}

    <script>
      function animateTitleAndSpeak() {
        const text = "Pneumonia Detection from Chest X-Rays Using CNN";
        const container = document.getElementById("animated-title");
        let i = 0;
        let titleText = '';

        function typeChar() {
          if (i < text.length) {
            const span = document.createElement("span");
            const char = text[i];
            span.textContent = char;
            if (char === " ") span.style.marginRight = "8px"; // Add spacing for spaces
            container.appendChild(span);

            setTimeout(() => {
              span.classList.add("visible");
            }, 10);

            titleText += char;
            i++;
            setTimeout(typeChar, 80);
          } else {
            // After title animation, speak it
            const utterance = new SpeechSynthesisUtterance(titleText);
            utterance.rate = 1;
            utterance.pitch = 1;
            utterance.lang = 'en-US';
            window.speechSynthesis.speak(utterance);
          }
        }

        typeChar();
      }

      function animateListItems() {
  const list = document.getElementById("suggestion-list");
  if (!list) return;

  const items = list.querySelectorAll("li");

  items.forEach((item, itemIndex) => {
    const text = item.textContent;
    item.textContent = "";

    [...text].forEach((char, charIndex) => {
      const span = document.createElement("span");
      span.classList.add("char");
      span.textContent = char === " " ? "\u00A0" : char; // Fix: add space visibly
      item.appendChild(span);

      setTimeout(() => {
        span.classList.add("visible");
      }, (charIndex * 30) + (itemIndex * 800));
    });
  });
}


      function speakSuggestions() {
        const list = document.getElementById("suggestion-list");
        const predictionHeading = document.querySelector("h2.text-center");

        if (!predictionHeading) return;

        const diagnosis = predictionHeading.textContent.trim();  // "Person is Pneumonia Positive (99.45%)"
        const match = diagnosis.match(/(Positive|Negative)\s*\(([\d.]+)%\)/);
        let spokenText = "";

        if (match) {
          const label = match[1];
          const accuracy = match[2];
          spokenText += `The person is pneumonia ${label}, with ${accuracy} percent confidence. `;

          if (label === "Positive" && list) {
            const suggestions = Array.from(list.querySelectorAll("li"))
              .map(li => li.textContent)
              .join(". ");
            spokenText += suggestions;
          }
        } else {
          spokenText += diagnosis + ". ";
        }

        const utterance = new SpeechSynthesisUtterance(spokenText);
        utterance.rate = 1;
        utterance.pitch = 1;
        utterance.lang = 'en-US';

        setTimeout(() => {
          window.speechSynthesis.speak(utterance);
        }, 3000);
      }

      window.onload = function () {
        animateTitleAndSpeak();
        animateListItems();
        speakSuggestions();
      };
    </script>
  </body>
</html>
